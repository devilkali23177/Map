<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindMapper Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            min-height: 90vh;
        }

        .auth-container, .app-container {
            padding: 20px;
            height: 100%;
        }

        .app-container {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #6c63ff;
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-email {
            margin-right: 15px;
        }

        button {
            background-color: #ff6584;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #e04e70;
        }

        .btn-primary {
            background-color: #6c63ff;
        }

        .btn-primary:hover {
            background-color: #554fd8;
        }

        .toolbar {
            display: flex;
            padding: 15px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .toolbar button {
            margin-right: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .toolbar button i {
            margin-right: 5px;
        }

        .mindmap-container {
            flex: 1;
            padding: 20px;
            overflow: auto;
            background-color: #f9f9f9;
            position: relative;
        }

        #mindmap {
            width: 100%;
            height: 100%;
            min-height: 500px;
            position: relative;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            overflow: auto;
            transform-origin: 0 0;
        }

        .node {
            position: absolute;
            background: white;
            border: 2px solid #6c63ff;
            border-radius: 8px;
            padding: 12px;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
            user-select: none;
        }

        .node:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .node.selected {
            border-color: #ff6584;
            background-color: #fff0f3;
        }

        .node-content {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .connection {
            position: absolute;
            background-color: #6c63ff;
            transform-origin: 0 0;
            z-index: 5;
            pointer-events: none;
        }

        .auth-form {
            max-width: 400px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .auth-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #6c63ff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .auth-actions {
            display: flex;
            justify-content: space-between;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #555;
        }

        .auth-switch a {
            color: #6c63ff;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .node-editor {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }

        .node-editor input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .mindmap-controls {
            display: flex;
            align-items: center;
            margin-left: auto;
        }

        .mindmap-controls button {
            margin-left: 10px;
        }

        .mindmap-selector {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-right: 10px;
        }

        .mindmap-manager {
            margin-left: 10px;
        }

        .zoom-controls {
            display: flex;
            margin-left: 15px;
        }

        .zoom-controls button {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
        }

        .connection-mode .node {
            cursor: crosshair;
        }

        .mindmap-info {
            margin-left: 15px;
            color: #555;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .toolbar button {
                margin-bottom: 10px;
                width: 100%;
            }
            
            .user-info {
                flex-direction: column;
                align-items: flex-end;
            }
            
            .user-email {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .mindmap-controls {
                width: 100%;
                margin-top: 10px;
                justify-content: space-between;
            }
        }

        .welcome-message {
            text-align: center;
            margin-bottom: 30px;
        }

        .welcome-message h1 {
            color: #6c63ff;
            margin-bottom: 10px;
        }

        .welcome-message p {
            color: #666;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-container" id="authContainer">
            <div class="welcome-message">
                <h1>MindMapper Pro</h1>
                <p>Create and manage your mind maps with ease</p>
            </div>
            
            <div class="auth-form" id="loginForm">
                <h2>Login</h2>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <div class="auth-actions">
                    <button class="btn-primary" onclick="login()">Login</button>
                    <button onclick="resetPassword()">Reset Password</button>
                </div>
                <div class="auth-switch">
                    Don't have an account? <a onclick="showRegister()">Register</a>
                </div>
            </div>

            <div class="auth-form" id="registerForm" style="display: none;">
                <h2>Register</h2>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password">
                </div>
                <div class="auth-actions">
                    <button class="btn-primary" onclick="register()">Register</button>
                    <button onclick="showLogin()">Back to Login</button>
                </div>
            </div>
        </div>

        <div class="app-container" id="appContainer">
            <header>
                <div class="logo">
                    <i>🧠</i> MindMapper Pro
                </div>
                <div class="user-info">
                    <div class="user-email" id="userEmail"></div>
                    <button onclick="logout()">Logout</button>
                </div>
            </header>

            <div class="toolbar">
                <button class="btn-primary" onclick="addNode()">
                    <i>+</i> Add Node
                </button>
                <button onclick="deleteNode()">
                    <i>🗑️</i> Delete Node
                </button>
                <button id="connectButton" onclick="toggleConnectionMode()">
                    <i>🔗</i> Connect Nodes
                </button>
                <button onclick="saveMindmap()">
                    <i>💾</i> Save Mindmap
                </button>
                
                <div class="mindmap-controls">
                    <select class="mindmap-selector" id="mindmapSelector" onchange="switchMindmap()">
                        <option value="">Select Mindmap</option>
                    </select>
                    <button class="mindmap-manager" onclick="manageMindmaps()">
                        <i>📋</i> Manage
                    </button>
                    <button onclick="createNewMindmap()">
                        <i>➕</i> New
                    </button>
                    
                    <div class="zoom-controls">
                        <button onclick="zoomOut()">-</button>
                        <button onclick="resetZoom()">100%</button>
                        <button onclick="zoomIn()">+</button>
                    </div>
                    
                    <div class="mindmap-info" id="zoomLevel">100%</div>
                </div>
            </div>

            <div class="mindmap-container">
                <div id="mindmap"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlQI16Nmx5oo3VzyCDEb6V4M2cH9Bbwc8",
            authDomain: "mindmapping-58435.firebaseapp.com",
            databaseURL: "https://mindmapping-58435-default-rtdb.firebaseio.com",
            projectId: "mindmapping-58435",
            storageBucket: "mindmapping-58435.firebasestorage.app",
            messagingSenderId: "1059085761579",
            appId: "1:1059085761579:web:5422cefb56f5989af7be6e",
            measurementId: "G-9F7EZZ2C9T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM elements
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const userEmail = document.getElementById('userEmail');
        const mindmap = document.getElementById('mindmap');
        const mindmapSelector = document.getElementById('mindmapSelector');
        const connectButton = document.getElementById('connectButton');
        const zoomLevel = document.getElementById('zoomLevel');

        // Mindmap state
        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let connectionSource = null;
        let isConnectionMode = false;
        let nodeIdCounter = 0;
        let connectionIdCounter = 0;
        let currentMindmapId = null;
        let mindmaps = {};
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let startX, startY;
        let initialOffsetX, initialOffsetY;

        // Authentication state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                userEmail.textContent = user.email;
                authContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                loadMindmaps();
            } else {
                // User is signed out
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
            }
        });

        // Auth functions
        function showRegister() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        }

        function showLogin() {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    console.log('User logged in:', userCredential.user);
                })
                .catch((error) => {
                    alert('Login error: ' + error.message);
                });
        }

        function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed up
                    console.log('User registered:', userCredential.user);
                })
                .catch((error) => {
                    alert('Registration error: ' + error.message);
                });
        }

        function resetPassword() {
            const email = document.getElementById('loginEmail').value;
            if (!email) {
                alert('Please enter your email address first');
                return;
            }
            
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    alert('Password reset email sent!');
                })
                .catch((error) => {
                    alert('Error sending reset email: ' + error.message);
                });
        }

        function logout() {
            auth.signOut()
                .then(() => {
                    console.log('User signed out');
                })
                .catch((error) => {
                    alert('Logout error: ' + error.message);
                });
        }

        // Mindmap management functions
        function loadMindmaps() {
            const user = auth.currentUser;
            if (!user) return;
            
            database.ref('users/' + user.uid + '/mindmaps').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        mindmaps = data;
                        updateMindmapSelector();
                        
                        // Load the first mindmap if none is selected
                        if (!currentMindmapId && Object.keys(mindmaps).length > 0) {
                            const firstMindmapId = Object.keys(mindmaps)[0];
                            switchToMindmap(firstMindmapId);
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error loading mindmaps:', error);
                });
        }

        function updateMindmapSelector() {
            // Clear existing options except the first one
            while (mindmapSelector.options.length > 1) {
                mindmapSelector.remove(1);
            }
            
            // Add mindmaps to selector
            for (const id in mindmaps) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = mindmaps[id].name || 'Unnamed Mindmap';
                option.selected = (id === currentMindmapId);
                mindmapSelector.appendChild(option);
            }
        }

        function switchMindmap() {
            const selectedId = mindmapSelector.value;
            if (selectedId && selectedId !== currentMindmapId) {
                // Save current mindmap first
                if (currentMindmapId) {
                    saveCurrentMindmapData();
                }
                
                // Switch to selected mindmap
                switchToMindmap(selectedId);
            }
        }

        function switchToMindmap(id) {
            currentMindmapId = id;
            const mindmapData = mindmaps[id];
            
            if (mindmapData) {
                nodes = mindmapData.nodes || [];
                connections = mindmapData.connections || [];
                nodeIdCounter = mindmapData.nodeIdCounter || 0;
                connectionIdCounter = mindmapData.connectionIdCounter || 0;
            } else {
                nodes = [];
                connections = [];
                nodeIdCounter = 0;
                connectionIdCounter = 0;
            }
            
            selectedNode = null;
            connectionSource = null;
            isConnectionMode = false;
            connectButton.classList.remove('active');
            
            // Reset view
            scale = 1;
            offsetX = 0;
            offsetY = 0;
            updateMindmapTransform();
            
            renderMindmap();
        }

        function saveCurrentMindmapData() {
            if (!currentMindmapId) return;
            
            mindmaps[currentMindmapId] = {
                name: mindmaps[currentMindmapId]?.name || 'New Mindmap',
                nodes: nodes,
                connections: connections,
                nodeIdCounter: nodeIdCounter,
                connectionIdCounter: connectionIdCounter
            };
        }

        function createNewMindmap() {
            const mindmapName = prompt('Enter a name for your new mindmap:');
            if (mindmapName === null) return;
            
            const user = auth.currentUser;
            if (!user) {
                alert('You must be logged in to create mindmaps');
                return;
            }
            
            // Generate a unique ID for the new mindmap
            const newMindmapId = 'mindmap_' + Date.now();
            
            // Save current mindmap first if one is active
            if (currentMindmapId) {
                saveCurrentMindmapData();
            }
            
            // Create the new mindmap
            mindmaps[newMindmapId] = {
                name: mindmapName,
                nodes: [],
                connections: [],
                nodeIdCounter: 0,
                connectionIdCounter: 0
            };
            
            // Switch to the new mindmap
            currentMindmapId = newMindmapId;
            nodes = [];
            connections = [];
            nodeIdCounter = 0;
            connectionIdCounter = 0;
            selectedNode = null;
            
            // Reset view
            scale = 1;
            offsetX = 0;
            offsetY = 0;
            updateMindmapTransform();
            
            // Add a central node
            addCentralNode();
            
            // Update UI
            updateMindmapSelector();
            renderMindmap();
            
            // Save to database
            saveAllMindmaps();
        }

        function manageMindmaps() {
            let managementText = "Your Mindmaps:\n\n";
            for (const id in mindmaps) {
                managementText += `- ${mindmaps[id].name}\n`;
            }
            
            const action = prompt(managementText + "\nEnter 'delete' to remove a mindmap or 'rename' to rename one:");
            if (!action) return;
            
            if (action === 'delete') {
                const toDelete = prompt("Enter the name of the mindmap to delete:");
                if (!toDelete) return;
                
                let foundId = null;
                for (const id in mindmaps) {
                    if (mindmaps[id].name === toDelete) {
                        foundId = id;
                        break;
                    }
                }
                
                if (foundId) {
                    if (confirm(`Are you sure you want to delete "${toDelete}"?`)) {
                        // If deleting the current mindmap, switch to another one first
                        if (foundId === currentMindmapId) {
                            const otherMindmaps = Object.keys(mindmaps).filter(id => id !== foundId);
                            if (otherMindmaps.length > 0) {
                                switchToMindmap(otherMindmaps[0]);
                            } else {
                                currentMindmapId = null;
                                nodes = [];
                                connections = [];
                                renderMindmap();
                            }
                        }
                        
                        delete mindmaps[foundId];
                        updateMindmapSelector();
                        saveAllMindmaps();
                    }
                } else {
                    alert('Mindmap not found');
                }
            } else if (action === 'rename') {
                const toRename = prompt("Enter the name of the mindmap to rename:");
                if (!toRename) return;
                
                let foundId = null;
                for (const id in mindmaps) {
                    if (mindmaps[id].name === toRename) {
                        foundId = id;
                        break;
                    }
                }
                
                if (foundId) {
                    const newName = prompt("Enter the new name:", toRename);
                    if (newName) {
                        mindmaps[foundId].name = newName;
                        updateMindmapSelector();
                        saveAllMindmaps();
                    }
                } else {
                    alert('Mindmap not found');
                }
            }
        }

        function saveAllMindmaps() {
            const user = auth.currentUser;
            if (!user) return;
            
            database.ref('users/' + user.uid + '/mindmaps').set(mindmaps)
                .catch((error) => {
                    alert('Error saving mindmaps: ' + error.message);
                });
        }

        // Mindmap functions
        function addNode() {
            if (!currentMindmapId) {
                alert('Please create or select a mindmap first');
                return;
            }
            
            const newNode = {
                id: nodeIdCounter++,
                x: (mindmap.offsetWidth / 2 - 60 - offsetX) / scale,
                y: (mindmap.offsetHeight / 2 - 30 - offsetY) / scale,
                content: 'New Node',
                width: 120,
                height: 60
            };
            
            nodes.push(newNode);
            renderMindmap();
        }

        function addCentralNode() {
            const centralNode = {
                id: nodeIdCounter++,
                x: mindmap.offsetWidth / 2 - 60,
                y: mindmap.offsetHeight / 2 - 30,
                content: 'Central Idea',
                width: 120,
                height: 60
            };
            nodes.push(centralNode);
            renderMindmap();
        }

        function deleteNode() {
            if (!selectedNode) {
                alert('Please select a node to delete');
                return;
            }
            
            // Remove any connections to/from this node
            connections = connections.filter(conn => 
                conn.sourceId !== selectedNode.id && conn.targetId !== selectedNode.id
            );
            
            nodes = nodes.filter(node => node.id !== selectedNode.id);
            selectedNode = null;
            renderMindmap();
        }

        function toggleConnectionMode() {
            isConnectionMode = !isConnectionMode;
            connectionSource = null;
            
            if (isConnectionMode) {
                connectButton.classList.add('active');
                mindmap.classList.add('connection-mode');
            } else {
                connectButton.classList.remove('active');
                mindmap.classList.remove('connection-mode');
            }
        }

        function createConnection(sourceId, targetId) {
            // Check if connection already exists
            const connectionExists = connections.some(conn => 
                (conn.sourceId === sourceId && conn.targetId === targetId) ||
                (conn.sourceId === targetId && conn.targetId === sourceId)
            );
            
            if (connectionExists) {
                alert('These nodes are already connected');
                return;
            }
            
            if (sourceId === targetId) {
                alert('Cannot connect a node to itself');
                return;
            }
            
            const newConnection = {
                id: connectionIdCounter++,
                sourceId: sourceId,
                targetId: targetId
            };
            
            connections.push(newConnection);
            renderMindmap();
        }

        function renderMindmap() {
            mindmap.innerHTML = '';
            
            // Draw connections first (so they appear behind nodes)
            connections.forEach(conn => {
                const sourceNode = nodes.find(n => n.id === conn.sourceId);
                const targetNode = nodes.find(n => n.id === conn.targetId);
                
                if (sourceNode && targetNode) {
                    drawConnection(sourceNode, targetNode);
                }
            });
            
            // Draw nodes
            nodes.forEach(node => {
                const nodeElement = document.createElement('div');
                nodeElement.className = 'node' + (selectedNode && selectedNode.id === node.id ? ' selected' : '');
                nodeElement.style.left = (node.x * scale + offsetX) + 'px';
                nodeElement.style.top = (node.y * scale + offsetY) + 'px';
                nodeElement.style.width = (node.width * scale) + 'px';
                nodeElement.style.height = (node.height * scale) + 'px';
                nodeElement.innerHTML = `<div class="node-content">${node.content}</div>`;
                
                nodeElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    if (isConnectionMode) {
                        if (!connectionSource) {
                            connectionSource = node;
                            nodeElement.classList.add('selected');
                        } else {
                            if (connectionSource.id !== node.id) {
                                createConnection(connectionSource.id, node.id);
                            }
                            connectionSource = null;
                            isConnectionMode = false;
                            connectButton.classList.remove('active');
                            mindmap.classList.remove('connection-mode');
                        }
                    } else {
                        selectNode(node);
                    }
                });
                
                nodeElement.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    editNode(node);
                });
                
                // Make nodes draggable
                makeDraggable(nodeElement, node);
                
                mindmap.appendChild(nodeElement);
            });
        }

        function drawConnection(sourceNode, targetNode) {
            const line = document.createElement('div');
            line.className = 'connection';
            
            const startX = sourceNode.x * scale + offsetX + (sourceNode.width * scale) / 2;
            const startY = sourceNode.y * scale + offsetY + (sourceNode.height * scale) / 2;
            const endX = targetNode.x * scale + offsetX + (targetNode.width * scale) / 2;
            const endY = targetNode.y * scale + offsetY + (targetNode.height * scale) / 2;
            
            // Calculate length and angle of the line
            const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
            
            // Position and style the line
            line.style.width = length + 'px';
            line.style.height = '2px';
            line.style.left = startX + 'px';
            line.style.top = startY + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            
            mindmap.appendChild(line);
        }

        function makeDraggable(element, node) {
            let isDragging = false;
            let startX, startY;
            
            element.addEventListener('mousedown', (e) => {
                if (isConnectionMode) return;
                
                isDragging = true;
                startX = e.clientX - offsetX - node.x * scale;
                startY = e.clientY - offsetY - node.y * scale;
                element.style.cursor = 'grabbing';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                node.x = (e.clientX - startX - offsetX) / scale;
                node.y = (e.clientY - startY - offsetY) / scale;
                renderMindmap();
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                element.style.cursor = 'pointer';
            });
            
            // Touch events for mobile
            element.addEventListener('touchstart', (e) => {
                if (isConnectionMode) return;
                
                isDragging = true;
                const touch = e.touches[0];
                startX = touch.clientX - offsetX - node.x * scale;
                startY = touch.clientY - offsetY - node.y * scale;
                e.preventDefault();
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                
                const touch = e.touches[0];
                node.x = (touch.clientX - startX - offsetX) / scale;
                node.y = (touch.clientY - startY - offsetY) / scale;
                renderMindmap();
                e.preventDefault();
            });
            
            document.addEventListener('touchend', () => {
                isDragging = false;
            });
        }

        function selectNode(node) {
            selectedNode = node;
            renderMindmap();
        }

        function editNode(node) {
            const newContent = prompt('Edit node content:', node.content);
            if (newContent !== null) {
                node.content = newContent;
                renderMindmap();
            }
        }

        function saveMindmap() {
            const user = auth.currentUser;
            if (!user) {
                alert('You must be logged in to save mindmaps');
                return;
            }
            
            if (!currentMindmapId) {
                alert('Please create or select a mindmap first');
                return;
            }
            
            // Update current mindmap data
            saveCurrentMindmapData();
            
            // Save to database
            saveAllMindmaps();
            alert('Mindmap saved successfully!');
        }

        function clearMindmap() {
            if (confirm('Are you sure you want to clear the mindmap?')) {
                nodes = [];
                connections = [];
                nodeIdCounter = 0;
                connectionIdCounter = 0;
                selectedNode = null;
                renderMindmap();
            }
        }

        // Zoom and pan functions
        function zoomIn() {
            scale *= 1.2;
            updateMindmapTransform();
        }

        function zoomOut() {
            scale /= 1.2;
            updateMindmapTransform();
        }

        function resetZoom() {
            scale = 1;
            offsetX = 0;
            offsetY = 0;
            updateMindmapTransform();
        }

        function updateMindmapTransform() {
            mindmap.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
            zoomLevel.textContent = Math.round(scale * 100) + '%';
            renderMindmap();
        }

        // Setup panning
        mindmap.addEventListener('mousedown', (e) => {
            if (e.button === 1 || (e.button === 0 && e.altKey)) { // Middle click or Alt+Left click
                isDragging = true;
                startX = e.clientX - offsetX;
                startY = e.clientY - offsetY;
                initialOffsetX = offsetX;
                initialOffsetY = offsetY;
                mindmap.style.cursor = 'grabbing';
                e.preventDefault();
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                offsetX = e.clientX - startX;
                offsetY = e.clientY - startY;
                updateMindmapTransform();
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            mindmap.style.cursor = 'default';
        });

        // Zoom with mouse wheel
        mindmap.addEventListener('wheel', (e) => {
            if (e.ctrlKey) {
                e.preventDefault();
                const rect = mindmap.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const zoomIntensity = 0.1;
                const wheel = e.deltaY < 0 ? 1 : -1;
                const zoom = Math.exp(wheel * zoomIntensity);
                
                // Calculate the mouse position in the current coordinate system
                const worldMouseX = (mouseX - offsetX) / scale;
                const worldMouseY = (mouseY - offsetY) / scale;
                
                // Apply zoom
                scale *= zoom;
                
                // Adjust offset so the point under the mouse stays fixed
                offsetX = mouseX - worldMouseX * scale;
                offsetY = mouseY - worldMouseY * scale;
                
                updateMindmapTransform();
            }
        });

        // Touch events for mobile zoom and pan
        let touchStartDistance = null;
        let touchStartScale = null;
        let touchStartOffsetX = null;
        let touchStartOffsetY = null;

        mindmap.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                // Two-finger touch for zooming
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                touchStartDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                touchStartScale = scale;
                touchStartOffsetX = offsetX;
                touchStartOffsetY = offsetY;
            } else if (e.touches.length === 1 && !isConnectionMode) {
                // One-finger touch for panning
                isDragging = true;
                const touch = e.touches[0];
                startX = touch.clientX - offsetX;
                startY = touch.clientY - offsetY;
                initialOffsetX = offsetX;
                initialOffsetY = offsetY;
            }
        });

        mindmap.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                // Two-finger pinch zoom
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                if (touchStartDistance) {
                    const zoom = currentDistance / touchStartDistance;
                    scale = touchStartScale * zoom;
                    
                    // Calculate center point between the two fingers
                    const centerX = (touch1.clientX + touch2.clientX) / 2;
                    const centerY = (touch1.clientY + touch2.clientY) / 2;
                    
                    // Adjust offset to zoom toward the center point
                    const rect = mindmap.getBoundingClientRect();
                    const worldCenterX = (centerX - rect.left - touchStartOffsetX) / touchStartScale;
                    const worldCenterY = (centerY - rect.top - touchStartOffsetY) / touchStartScale;
                    
                    offsetX = centerX - rect.left - worldCenterX * scale;
                    offsetY = centerY - rect.top - worldCenterY * scale;
                    
                    updateMindmapTransform();
                }
            } else if (e.touches.length === 1 && isDragging) {
                // One-finger pan
                const touch = e.touches[0];
                offsetX = touch.clientX - startX;
                offsetY = touch.clientY - startY;
                updateMindmapTransform();
            }
        });

        mindmap.addEventListener('touchend', () => {
            isDragging = false;
            touchStartDistance = null;
        });

        // Initialize the app
        window.addEventListener('load', () => {
            // Add a central node if no mindmap is loaded after a short delay
            setTimeout(() => {
                if (nodes.length === 0 && !currentMindmapId) {
                    addCentralNode();
                }
            }, 1000);
        });
    </script>
</body>
</html>